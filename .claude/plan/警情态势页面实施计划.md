# è­¦æƒ…æ€åŠ¿é¡µé¢å®æ–½è®¡åˆ’

> **åˆ›å»ºæ—¶é—´**: 2026-01-23
> **æ¨¡å—**: è­¦æƒ…æ€åŠ¿ç›‘æ§è¿½è¸ªé¡µé¢
> **æŠ€æœ¯æ ˆ**: Vue 3 + FastAPI + DataV + å¤©åœ°å›¾API
> **ä¼šè¯ID**:
> - Gemini: 3786dbcd-65be-48b7-86cb-cef2b175ab05
> - Codex: 019be8cf-9c20-7981-808f-0600eec52418

---

## ğŸ“‹ UIå¸ƒå±€æ–¹æ¡ˆï¼ˆå·²æ‰¹å‡†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PageHeaderï¼ˆå…¨å±€æ—¶é—´åˆ‡æ¢ï¼šå‘¨/æœˆ/å¹´ï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            â”‚                          â”‚                     â”‚
â”‚  è¡¨1       â”‚                          â”‚  è¡¨5                â”‚
â”‚  è­¦æƒ…æ€»è§ˆ  â”‚                          â”‚  çº çº·è¯¦æƒ…           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  è¡¨2       â”‚                          â”‚  è¡¨6                â”‚
â”‚  å·ç›—è¯¦æƒ…  â”‚      å¤©åœ°å›¾              â”‚  æ‰“æ¶è¯¦æƒ…           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚      (ä¸»ä½“60%)           â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  è¡¨3       â”‚                          â”‚  è¡¨7                â”‚
â”‚  ç”µè¯ˆè¯¦æƒ…  â”‚                          â”‚  æ¶‰èµŒè¯¦æƒ…           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  è¡¨4       â”‚                          â”‚  è¡¨8                â”‚
â”‚  æ¶‰é»„è¯¦æƒ…  â”‚                          â”‚  é‡å¤æŠ¥è­¦äºº         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¸ƒå±€è¯´æ˜ï¼š**
- å·¦ä¾§åˆ—ï¼ˆ20%ï¼‰ï¼šè¡¨1ï¼ˆæ€»è§ˆï¼‰+ è¡¨2-4ï¼ˆå·ç›—ã€ç”µè¯ˆã€æ¶‰é»„ï¼‰
- ä¸­é—´åŒºåŸŸï¼ˆ60%ï¼‰ï¼šå¤©åœ°å›¾ä¸»ä½“
- å³ä¾§åˆ—ï¼ˆ20%ï¼‰ï¼šè¡¨5-8ï¼ˆçº çº·ã€æ‰“æ¶ã€æ¶‰èµŒã€é‡å¤æŠ¥è­¦äººï¼‰

---

## ğŸ¯ åç«¯æ¶æ„è®¾è®¡

### APIæ¥å£è®¾è®¡

#### 1. ç»Ÿä¸€è­¦æƒ…ç»Ÿè®¡æ¥å£

```python
GET /api/v1/data/police-alerts/summary
```

**å‚æ•°ï¼š**
- `time_range`: week|month|yearï¼ˆå¿…å¡«ï¼‰
- `category`: è­¦æƒ…åˆ†ç±»ï¼ˆå¯é€‰ï¼‰

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "categories": [
      {
        "name": "å·ç›—/ä¼ ç»Ÿç›—è´¢",
        "count": 45,
        "comparison": {
          "mom": "+5.2%",  // ç¯æ¯”
          "yoy": "+12.3%"  // åŒæ¯”
        }
      },
      // ... å…¶ä»–6ä¸ªåˆ†ç±»
      {
        "name": "æœ‰æ•ˆè­¦æƒ…",
        "count": 234,  // æ€»è®¡
        "comparison": {...}
      }
    ]
  }
}
```

#### 2. åœ°ç‚¹åˆ†å¸ƒTopNæ¥å£ï¼ˆæ‰©å±•ç°æœ‰ï¼‰

```python
GET /api/v1/data/police-alerts/location-distribution
```

**å‚æ•°ï¼š**
- `alert_type`: è­¦æƒ…ç±»å‹ï¼ˆå¿…å¡«ï¼‰
- `time_range`: week|month|yearï¼ˆå¿…å¡«ï¼‰
- `top_n`: TopNæ•°é‡ï¼ˆé»˜è®¤5ï¼‰

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": [
    {
      "location": "ä¸œæ¸¯å°åŒº",
      "count": 45,
      "lng": 122.30,
      "lat": 29.95
    },
    // ... Top N
  ]
}
```

#### 3. é‡å¤æŠ¥è­¦äººæ¥å£ï¼ˆå·²æœ‰ï¼‰

```python
GET /api/v1/data/call-records/repeat-reporters
```

**å‚æ•°ï¼š**
- `min_count`: æœ€å°æŠ¥è­¦æ¬¡æ•°ï¼ˆé»˜è®¤2ï¼‰

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": [
    {
      "reporter_name": "å¼ ä¸‰",
      "count": 4,
      "last_call_time": "2026-01-22T10:30:00"
    },
    // ... Top 5
  ]
}
```

### æ•°æ®èšåˆé€»è¾‘

**åŒç¯æ¯”è®¡ç®—ï¼š**
```python
# ç¯æ¯”ï¼ˆMonth-over-Monthï¼‰
mom = (current_period - last_period) / last_period * 100

# åŒæ¯”ï¼ˆYear-over-Yearï¼‰
yoy = (current_period - same_period_last_year) / same_period_last_year * 100
```

**æ—¶é—´ç»´åº¦å¯¹é½ï¼š**
- week: ä»¥å‘¨ä¸€ä¸ºèµ·å§‹
- month: ä»¥æœˆåˆä¸ºèµ·å§‹
- year: ä»¥å¹´åˆä¸ºèµ·å§‹

**TopNæ’åºï¼š**
```python
# æŒ‰counté™åºï¼Œå–å‰Næ¡
query.order_by(func.count().desc()).limit(top_n)
```

### æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

**ç´¢å¼•ä¼˜åŒ–ï¼š**
```sql
CREATE INDEX idx_alert_time ON t_police_alert(alert_time);
CREATE INDEX idx_alert_type ON t_police_alert(alert_type);
CREATE INDEX idx_alert_community ON t_police_alert(location_community);
```

**ç¼“å­˜ç­–ç•¥ï¼š**
- ä½¿ç”¨å†…å­˜ç¼“å­˜ï¼ˆfunctools.lru_cacheï¼‰
- ç¼“å­˜æ—¶é—´ï¼š60-300ç§’
- ç¼“å­˜é”®ï¼š`{time_range}:{category}:{date_range}`

**æŸ¥è¯¢ä¼˜åŒ–ï¼š**
- ä½¿ç”¨SQLAlchemyçš„`func.count()`è¿›è¡Œèšåˆ
- é¿å…N+1æŸ¥è¯¢
- ä½¿ç”¨`joinedload`é¢„åŠ è½½å…³è”æ•°æ®

---

## ğŸ¨ å‰ç«¯æ¶æ„è®¾è®¡

### ç»„ä»¶ç»“æ„

```
/src
â”œâ”€â”€â”€views/
â”‚   â””â”€â”€â”€PoliceSituation.vue       # é¡µé¢ä¸»å®¹å™¨
â”‚
â”œâ”€â”€â”€components/
â”‚   â”œâ”€â”€â”€police-situation/
â”‚   â”‚   â”œâ”€â”€â”€DataCard.vue          # é€šç”¨å¡ç‰‡å¤–å£³
â”‚   â”‚   â”œâ”€â”€â”€OverviewCard.vue      # è¡¨1ï¼šè­¦æƒ…æ€»è§ˆ
â”‚   â”‚   â”œâ”€â”€â”€DetailListCard.vue    # è¡¨2-8ï¼šé€šç”¨è¯¦æƒ…åˆ—è¡¨
â”‚   â”‚   â””â”€â”€â”€GlobalTimeFilter.vue  # å…¨å±€æ—¶é—´åˆ‡æ¢å™¨
â”‚   â”‚
â”‚   â””â”€â”€â”€common/
â”‚       â””â”€â”€â”€TdtMap.vue            # å¤©åœ°å›¾å°è£…ç»„ä»¶
â”‚
â””â”€â”€â”€stores/
    â””â”€â”€â”€situation.ts              # PiniaçŠ¶æ€ç®¡ç†
```

### çŠ¶æ€ç®¡ç†ï¼ˆPiniaï¼‰

```typescript
// stores/situation.ts
export const useSituationStore = defineStore('situation', {
  state: () => ({
    // å…¨å±€æ—¶é—´ç»´åº¦
    timePeriod: 'week', // 'week' | 'month' | 'year'

    // å½“å‰é«˜äº®çš„è­¦æƒ…åˆ†ç±»
    highlightedCategory: null as string | null,

    // å„æ¨¡å—æ•°æ®
    overviewData: [],
    theftData: [],
    fraudData: [],
    yellowData: [],
    disputeData: [],
    fightData: [],
    gambleData: [],
    repeatReportersData: [],

    // åœ°å›¾ç„¦ç‚¹ä½ç½®
    targetLocation: null as LocationData | null,
  }),

  getters: {
    // è®¡ç®—åœ°å›¾æ ‡è®°
    mapMarkers: (state): LocationData[] => {
      if (!state.highlightedCategory) return [];
      switch (state.highlightedCategory) {
        case 'å·ç›—': return state.theftData;
        case 'ç”µè¯ˆ': return state.fraudData;
        // ... å…¶ä»–åˆ†ç±»
        default: return [];
      }
    },
  },

  actions: {
    // è®¾ç½®æ—¶é—´ç»´åº¦å¹¶åˆ·æ–°æ•°æ®
    async setTimePeriod(period: string) {
      this.timePeriod = period;
      await this.fetchAllData();
    },

    // è®¾ç½®é«˜äº®åˆ†ç±»
    setHighlightedCategory(category: string) {
      this.highlightedCategory = category;
    },

    // è®¾ç½®åœ°å›¾ç„¦ç‚¹
    setTargetLocation(location: LocationData) {
      this.targetLocation = location;
    },

    // è·å–æ‰€æœ‰æ•°æ®ï¼ˆå¹¶è¡Œï¼‰
    async fetchAllData() {
      const period = this.timePeriod;
      [
        this.overviewData,
        this.theftData,
        this.fraudData,
        // ...
      ] = await Promise.all([
        api.fetchSummary({ time_range: period }),
        api.fetchLocationDistribution({ alert_type: 'å·ç›—/ä¼ ç»Ÿç›—è´¢', time_range: period }),
        api.fetchLocationDistribution({ alert_type: 'é€šè®¯ç½‘ç»œè¯ˆéª—/æ–°å‹ç›—è´¢', time_range: period }),
        // ... å…¶ä»–æ¥å£
      ]);
    },
  },
});
```

### åœ°å›¾é›†æˆæ–¹æ¡ˆ

**TdtMap.vue æ ¸å¿ƒé€»è¾‘ï¼š**

```vue
<script setup>
import { ref, watch, onMounted } from 'vue';

const props = defineProps({
  center: Array,  // [lng, lat]
  zoom: Number,
  markers: Array, // [{id, name, count, lng, lat}]
});

const emit = defineEmits(['marker-click']);

let mapInstance = null;
const markerCache = new Map();

onMounted(() => {
  // åˆå§‹åŒ–å¤©åœ°å›¾
  mapInstance = new T.Map('mapDiv');
  mapInstance.centerAndZoom(new T.LngLat(props.center[0], props.center[1]), props.zoom);
});

// ç›‘å¬æ ‡è®°å˜åŒ–
watch(() => props.markers, (newMarkers) => {
  // æ›´æ–°åœ°å›¾æ ‡è®°
  updateMarkers(newMarkers);
}, { deep: true });

// ç›‘å¬ä¸­å¿ƒç‚¹å˜åŒ–
watch(() => props.center, (newCenter) => {
  mapInstance.panTo(new T.LngLat(newCenter[0], newCenter[1]));
});

function updateMarkers(markers) {
  // æ¸…é™¤æ—§æ ‡è®°
  markerCache.forEach(marker => mapInstance.removeOverLay(marker));
  markerCache.clear();

  // æ·»åŠ æ–°æ ‡è®°
  markers.forEach(item => {
    const marker = new T.Marker(new T.LngLat(item.lng, item.lat));
    marker.addEventListener('click', () => emit('marker-click', item));
    mapInstance.addOverLay(marker);
    markerCache.set(item.id, marker);
  });
}
</script>
```

### äº¤äº’å®ç°ç»†èŠ‚

**1. å…¨å±€æ—¶é—´åˆ‡æ¢ï¼š**
```vue
<!-- GlobalTimeFilter.vue -->
<button @click="store.setTimePeriod('week')">å‘¨</button>
<button @click="store.setTimePeriod('month')">æœˆ</button>
<button @click="store.setTimePeriod('year')">å¹´</button>
```

**2. æ€»è§ˆç‚¹å‡» â†’ è¯¦æƒ…é«˜äº® + åœ°å›¾æ˜¾ç¤ºï¼š**
```vue
<!-- OverviewCard.vue -->
<dv-scroll-board
  :config="config"
  @click="handleRowClick"
/>

function handleRowClick(row) {
  const category = row[1]; // åˆ†ç±»åç§°
  store.setHighlightedCategory(category);
}
```

**3. è¯¦æƒ…ç‚¹å‡» â†’ åœ°å›¾å®šä½ï¼š**
```vue
<!-- DetailListCard.vue -->
<dv-scroll-board
  :config="config"
  @click="handleRowClick"
/>

function handleRowClick(row) {
  const location = {
    name: row[1],
    lng: row.lng,
    lat: row.lat
  };
  store.setTargetLocation(location);
}
```

**4. åœ°å›¾ç‚¹å‡» â†’ è¯¦æƒ…é«˜äº®ï¼š**
```vue
<!-- PoliceSituation.vue -->
<TdtMap
  @marker-click="handleMarkerClick"
/>

function handleMarkerClick(marker) {
  store.setHighlightedCategory(marker.category);
}
```

### æ ·å¼è®¾è®¡è§„èŒƒ

**é…è‰²æ–¹æ¡ˆï¼ˆuno.config.tsï¼‰ï¼š**
```javascript
theme: {
  colors: {
    'police-main': '#1e3a8a',
    'police-light': '#3b82f6',
    'police-accent': '#67e8f9',
    'trend-up': '#f87171',    // ä¸Šå‡çº¢è‰²
    'trend-down': '#2dd4bf',  // ä¸‹é™é’è‰²
  }
}
```

**é€šç”¨æ ·å¼ç±»ï¼š**
- å¡ç‰‡ï¼š`bg-police-main/60 backdrop-blur-sm border border-police-light/40 rounded-lg p-4`
- æ ‡é¢˜ï¼š`text-police-accent text-lg font-bold mb-2`
- é«˜äº®ï¼š`shadow-[0_0_15px_rgba(59,130,246,0.8)]`
- åŒç¯æ¯”ä¸Šå‡ï¼š`text-trend-up flex items-center`
- åŒç¯æ¯”ä¸‹é™ï¼š`text-trend-down flex items-center`

---

## ğŸ“ å®æ–½æ­¥éª¤

### åç«¯å®æ–½ï¼ˆ2-3å°æ—¶ï¼‰

1. **æ‰©å±•APIæ¥å£**
   - [ ] å®ç° `/api/v1/data/police-alerts/summary` æ¥å£
   - [ ] æ‰©å±• `/api/v1/data/police-alerts/location-distribution` æ”¯æŒtime_rangeå‚æ•°
   - [ ] å®ç°åŒç¯æ¯”è®¡ç®—é€»è¾‘

2. **æ€§èƒ½ä¼˜åŒ–**
   - [ ] æ·»åŠ æ•°æ®åº“ç´¢å¼•
   - [ ] å®ç°ç¼“å­˜æœºåˆ¶
   - [ ] æµ‹è¯•æ¥å£æ€§èƒ½

### å‰ç«¯å®æ–½ï¼ˆ3-4å°æ—¶ï¼‰

1. **ç¯å¢ƒæ­å»º**
   - [ ] å®‰è£…Pinia
   - [ ] é…ç½®UnoCSSä¸»é¢˜è‰²

2. **çŠ¶æ€ç®¡ç†**
   - [ ] åˆ›å»º `stores/situation.ts`
   - [ ] å®ç°stateã€gettersã€actions

3. **ç»„ä»¶å¼€å‘**
   - [ ] `DataCard.vue` - é€šç”¨å¡ç‰‡å¤–å£³
   - [ ] `GlobalTimeFilter.vue` - æ—¶é—´åˆ‡æ¢å™¨
   - [ ] `OverviewCard.vue` - è­¦æƒ…æ€»è§ˆ
   - [ ] `DetailListCard.vue` - é€šç”¨è¯¦æƒ…åˆ—è¡¨
   - [ ] `TdtMap.vue` - å¤©åœ°å›¾å°è£…

4. **é¡µé¢ç»„è£…**
   - [ ] `PoliceSituation.vue` - ä¸»å®¹å™¨å¸ƒå±€
   - [ ] å®ç°æ‰€æœ‰äº¤äº’é€»è¾‘
   - [ ] è”è°ƒæµ‹è¯•

5. **æ ·å¼ä¼˜åŒ–**
   - [ ] åº”ç”¨æ¯›ç»ç’ƒæ•ˆæœ
   - [ ] è°ƒæ•´åŒç¯æ¯”æ˜¾ç¤º
   - [ ] ä¼˜åŒ–å“åº”å¼å¸ƒå±€

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´æ€§**
   - âœ… 8ä¸ªæ¨¡å—å…¨éƒ¨å¯è§
   - âœ… å…¨å±€æ—¶é—´åˆ‡æ¢æ­£å¸¸
   - âœ… åŒç¯æ¯”æ•°æ®æ­£ç¡®
   - âœ… åœ°å›¾è”åŠ¨äº¤äº’æµç•…

2. **è§†è§‰æ•ˆæœ**
   - âœ… è­¦åŠ¡è“ä¸»é¢˜ä¸€è‡´
   - âœ… æ¯›ç»ç’ƒæ•ˆæœæ¸…æ™°
   - âœ… åŒç¯æ¯”é¢œè‰²åŒºåˆ†æ˜æ˜¾

3. **æ€§èƒ½æŒ‡æ ‡**
   - âœ… é¡µé¢åŠ è½½ < 2ç§’
   - âœ… äº¤äº’å“åº” < 500ms
   - âœ… åœ°å›¾æ¸²æŸ“æµç•…

---

## ğŸ“Œ æŠ€æœ¯é£é™©

1. **SQLiteå¹¶å‘æ€§èƒ½** - é«˜é¢‘æŸ¥è¯¢å¯èƒ½æˆä¸ºç“¶é¢ˆ
   - ç¼“è§£ï¼šä½¿ç”¨ç¼“å­˜ã€è€ƒè™‘è¿ç§»åˆ°PostgreSQL

2. **åŒç¯æ¯”è®¡ç®—å£å¾„** - å‘¨èµ·å§‹ã€è·¨æœˆå¤„ç†éœ€ç»Ÿä¸€
   - ç¼“è§£ï¼šæ˜ç¡®å®šä¹‰æ—¶é—´ç»´åº¦è§„åˆ™

3. **åœ°å›¾åæ ‡è´¨é‡** - åœ°å€ç¼ºå¤±æˆ–åæ ‡åå·®
   - ç¼“è§£ï¼šä½¿ç”¨åœ°ç†ç¼–ç ç¼“å­˜è¡¨ï¼Œæå‰éªŒè¯æ•°æ®

---

## ğŸ”„ åç»­ä¼˜åŒ–

1. å¼•å…¥é¢„èšåˆè¡¨æå‡æ€§èƒ½
2. æ·»åŠ æ•°æ®å¯¼å‡ºåŠŸèƒ½
3. æ”¯æŒè‡ªå®šä¹‰æ—¶é—´èŒƒå›´
4. æ·»åŠ è­¦æƒ…è¶‹åŠ¿å›¾è¡¨
