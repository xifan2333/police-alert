# 警情态势演示系统 - 数据表设计（基于现有代码）

> **文档更新时间**：2026-01-23
> **设计状态**：风险盯办表✅、矛盾纠纷表✅、警情记录表⏳（待实现）
> **技术栈**：SQLAlchemy + SQLite

---

## 设计原则

1. **独立表设计**：每个业务模块使用独立的数据表
2. **规则驱动**：通过显示规则表配置颜色、排序等展示逻辑
3. **Excel导入**：支持通过Excel批量导入数据
4. **样式分离**：数据和样式规则分离，便于动态调整

---

## 已实现的数据表

### 1. 执法问题风险盯办表（t_risk_supervision）✅

存储执法问题风险盯办相关数据。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, AUTOINCREMENT | 主键ID |
| case_number | String(18) | UNIQUE, NOT NULL, INDEX | 案件编号（18位） |
| case_name | String(200) | NOT NULL | 案件名称 |
| case_time | DateTime | NOT NULL | 案发时间 |
| case_type | String(10) | NOT NULL | 案件类型（刑事/行政/治安） |
| risk_issues | Text | NOT NULL | 风险问题（JSON数组字符串） |
| deadline | DateTime | NOT NULL, INDEX | 整改期限 |
| officer_name | String(50) | NOT NULL | 责任民警 |
| created_at | DateTime | NOT NULL, DEFAULT NOW | 创建时间 |
| updated_at | DateTime | NOT NULL, DEFAULT NOW, ON UPDATE NOW | 更新时间 |

**约束条件：**
- `CHECK (length(case_number) = 18)` - 案件编号必须为18位
- `CHECK (case_type IN ('刑事', '行政', '治安'))` - 案件类型枚举

**索引：**
- `case_number` - 唯一索引
- `deadline` - 普通索引（用于排序）

**风险问题类型（存储在 risk_issues JSON 数组中）：**
- 案件笔录未关联
- XXX文书未开具
- 调解协议书未上传
- 执法音视频未上传
- 涉案物品未出入库
- 未结案卷未归档
- 治安案件延长审批
- 强制措施超期提醒

**排序规则：**
- 按 `deadline` 升序（最紧急的在前）
- 次要按 `case_time` 降序

**Excel 导入模板列：**
| 列名 | 必填 | 示例 |
|------|------|------|
| 案件编号 | ✓ | 330903202401010001 |
| 案件名称 | ✓ | 东港路入室盗窃案 |
| 案发时间 | ✓ | 2026-01-20 10:00 |
| 案件类型 | ✓ | 刑事 |
| 风险问题 | ✓ | 案件笔录未关联,执法音视频未上传 |
| 整改期限 | ✓ | 2026-01-30 18:00 |
| 责任民警 | ✓ | 张三 |

---

### 2. 矛盾纠纷闭环管理表（t_dispute_management）✅

存储矛盾纠纷闭环管理相关数据。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, AUTOINCREMENT | 主键ID |
| event_name | String(200) | NOT NULL | 事件名称 |
| event_type | String(100) | NOT NULL | 事件类型 |
| content | String(150) | NOT NULL | 事件内容（最多150字符） |
| event_time | DateTime | NOT NULL | 事发时间 |
| risk_level | String(10) | NOT NULL | 风险等级（高/中/低） |
| officer_name | String(50) | NOT NULL | 责任民警 |
| status | String(10) | NOT NULL | 处置进度 |
| created_at | DateTime | NOT NULL, DEFAULT NOW | 创建时间 |
| updated_at | DateTime | NOT NULL, DEFAULT NOW, ON UPDATE NOW | 更新时间 |

**约束条件：**
- `CHECK (length(content) <= 150)` - 事件内容最多150字符
- `CHECK (risk_level IN ('高', '中', '低'))` - 风险等级枚举
- `CHECK (status IN ('未调解', '待盯办', '调解中', '已调解'))` - 处置进度枚举

**索引：**
- `idx_dispute_status_risk` - 复合索引 (status, risk_level)
- `idx_dispute_event_time` - 普通索引 (event_time)
- `idx_dispute_risk_level` - 普通索引 (risk_level)

**排序规则：**
- 按风险等级优先（高 > 中 > 低）
- 次要按 `event_time` 降序

**默认筛选条件：**
- 处置进度：未调解、待盯办
- 风险等级：优先展示高风险

**Excel 导入模板列：**
| 列名 | 必填 | 示例 |
|------|------|------|
| 事件名称 | ✓ | 东港社区邻里纠纷 |
| 事件类型 | ✓ | 邻里纠纷 |
| 事件内容 | ✓ | 居民张某与李某因楼上漏水问题产生纠纷 |
| 事发时间 | ✓ | 2026-01-20 10:00 |
| 风险等级 | ✓ | 高 |
| 责任民警 | ✓ | 赵六 |
| 处置进度 | ✓ | 未调解 |

---

### 3. 显示规则配置表（t_display_rule）✅

存储数据展示的规则配置（颜色、排序等）。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, AUTOINCREMENT | 主键ID |
| page_code | String(50) | NOT NULL | 页面编码 |
| rule_type | String(50) | NOT NULL | 规则类型（color/sort/filter） |
| rule_name | String(100) | NOT NULL | 规则名称 |
| rule_config | Text | NOT NULL | 规则配置（JSON字符串） |
| priority | Integer | NOT NULL, DEFAULT 0 | 优先级（数字越小优先级越高） |
| is_enabled | Integer | NOT NULL, DEFAULT 1 | 是否启用（0否/1是） |
| description | Text | - | 规则说明 |
| created_at | DateTime | NOT NULL, DEFAULT NOW | 创建时间 |
| updated_at | DateTime | NOT NULL, DEFAULT NOW, ON UPDATE NOW | 更新时间 |

**索引：**
- `idx_display_rule_page_code` - 普通索引 (page_code)
- `idx_display_rule_rule_type` - 普通索引 (rule_type)
- `idx_display_rule_priority` - 普通索引 (priority)

**页面编码枚举：**
- `risk_supervision` - 执法问题风险盯办
- `dispute_management` - 矛盾纠纷闭环管理
- `situation_monitor` - 警情态势监控追踪（待实现）

**规则类型：**
- `color` - 颜色规则
- `sort` - 排序规则
- `filter` - 筛选规则

**规则配置示例：**

#### 执法问题 - 整改期限颜色规则
```json
{
  "field": "days_remaining",
  "conditions": [
    {
      "operator": "<=",
      "value": 3,
      "font_color": "#f5222d",
      "background_color": "#fff1f0",
      "style_token": "deadline_red"
    },
    {
      "operator": "<=",
      "value": 7,
      "font_color": "#faad14",
      "background_color": "#fffbe6",
      "style_token": "deadline_yellow"
    }
  ]
}
```

#### 矛盾纠纷 - 风险等级颜色规则
```json
{
  "field": "risk_level",
  "conditions": [
    {
      "operator": "eq",
      "value": "高",
      "font_color": "#f5222d",
      "background_color": "#fff1f0",
      "style_token": "risk_high"
    },
    {
      "operator": "eq",
      "value": "中",
      "font_color": "#faad14",
      "background_color": "#fffbe6",
      "style_token": "risk_mid"
    },
    {
      "operator": "eq",
      "value": "低",
      "font_color": "#52c41a",
      "background_color": "#f6ffed",
      "style_token": "risk_low"
    }
  ]
}
```

**规则应用逻辑：**
1. 按 `priority` 升序遍历规则
2. 检查 `is_enabled = 1` 的规则
3. 匹配第一个符合条件的规则后返回样式
4. 支持的操作符：`<=`, `>=`, `==`, `eq`, `in`

---

## 待实现的数据表

### 4. 警情记录表（t_police_alert）⏳

用于警情态势监控追踪页面，存储各类警情数据。

**设计建议：**
- 警情类型：偷盗/传统盗财、通讯网络诈骗/新型盗财、涉黄、涉赌、纠纷、人身伤害、打架斗殴等
- 地理信息：地点地址、所属社区、经纬度（用于地图展示）
- 时间信息：警情时间、报警时间
- 人员信息：报警人、责任民警
- 统计维度：支持按类型、地点、时间等多维度统计

---

## API 接口设计

### 数据查询接口

#### GET /api/v1/data/risk-supervision
获取执法问题风险盯办列表

**查询参数：**
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认50，最大100）
- `include_rules`: 是否包含规则（默认true）

**响应示例：**
```json
{
  "code": 200,
  "data": {
    "total": 50,
    "items": [
      {
        "id": 1,
        "case_number": "330903202401010001",
        "case_name": "东港路入室盗窃案",
        "case_time": "2026-01-15T10:30:00",
        "case_type": "刑事",
        "risk_issues": ["案件笔录未关联", "执法音视频未上传"],
        "deadline": "2026-01-25T18:00:00",
        "officer_name": "张三",
        "days_remaining": 2,
        "style": {
          "font_color": "#f5222d",
          "style_token": "deadline_red"
        }
      }
    ],
    "rules": [
      {
        "rule_type": "color",
        "rule_name": "整改期限颜色规则",
        "rule_config": {...},
        "priority": 1
      }
    ]
  }
}
```

#### GET /api/v1/data/dispute-management
获取矛盾纠纷闭环管理列表

**查询参数：**
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认50，最大100）
- `status`: 处置进度筛选（可选）
- `risk_level`: 风险等级筛选（可选）
- `include_rules`: 是否包含规则（默认true）

**响应示例：**
```json
{
  "code": 200,
  "data": {
    "total": 30,
    "items": [
      {
        "id": 1,
        "event_name": "东港社区邻里纠纷",
        "event_type": "邻里纠纷",
        "content": "居民张某与李某因楼上漏水问题产生纠纷",
        "event_time": "2026-01-20T10:00:00",
        "risk_level": "高",
        "officer_name": "赵六",
        "status": "未调解",
        "style": {
          "font_color": "#f5222d",
          "style_token": "risk_high"
        }
      }
    ],
    "rules": [...]
  }
}
```

---

### 管理后台接口

#### GET /api/v1/admin/template/{data_type}
下载 Excel 导入模板

**路径参数：**
- `data_type`: 数据类型（`risk_supervision` | `dispute_management`）

**响应：**
- Excel 文件下载

#### POST /api/v1/admin/import
导入 Excel 数据

**请求：**
- Content-Type: `multipart/form-data`
- `file`: Excel 文件
- `data_type`: 数据类型（`risk_supervision` | `dispute_management`）

**响应示例：**
```json
{
  "code": 200,
  "message": "导入成功",
  "data": {
    "imported_count": 50
  }
}
```

**导入逻辑：**
1. 清空现有数据（`DELETE FROM table`）
2. 逐行解析 Excel
3. 数据验证和类型转换
4. 批量插入数据库

#### GET /api/v1/admin/rules
获取所有显示规则

**响应示例：**
```json
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "page_code": "risk_supervision",
      "rule_type": "color",
      "rule_name": "整改期限颜色规则",
      "rule_config": {...},
      "priority": 1,
      "is_enabled": 1,
      "description": "根据剩余天数设置颜色"
    }
  ]
}
```

#### POST /api/v1/admin/rules
创建新规则

**请求体：**
```json
{
  "page_code": "risk_supervision",
  "rule_type": "color",
  "rule_name": "新规则",
  "rule_config": {...},
  "priority": 1,
  "is_enabled": 1,
  "description": "规则说明"
}
```

#### PUT /api/v1/admin/rules/{rule_id}
更新规则

**请求体：**
```json
{
  "rule_name": "更新后的规则名称",
  "rule_config": {...},
  "is_enabled": 0
}
```

#### DELETE /api/v1/admin/rules/{rule_id}
删除规则

---

## 数据库初始化

### 初始化流程

1. **创建表结构**
   ```python
   Base.metadata.create_all(bind=engine)
   ```

2. **初始化显示规则**
   - 执法问题 - 整改期限颜色规则
   - 矛盾纠纷 - 风险等级颜色规则

3. **初始化示例数据**
   - 执法问题示例数据（3条）
   - 矛盾纠纷示例数据（3条）

### 示例数据

**执法问题示例：**
- 东港路入室盗窃案（刑事，2天后到期，红色）
- 和平小区噪音扰民案（行政，6天后到期，黄色）
- 沈家门街道打架斗殴案（治安，10天后到期，正常）

**矛盾纠纷示例：**
- 东港社区邻里纠纷（高风险，未调解）
- 和平小区停车纠纷（中风险，待盯办）
- 沈家门街道商铺租赁纠纷（低风险，调解中）

---

## 业务逻辑

### 执法问题风险盯办

**计算剩余天数：**
```python
def calc_days_remaining(deadline: datetime) -> int:
    """计算距离截止日期的剩余天数"""
    now = datetime.now()
    delta = deadline - now
    return delta.days
```

**颜色规则应用：**
- `days_remaining <= 3` → 红色（#f5222d）
- `days_remaining <= 7` → 黄色（#faad14）
- 其他 → 正常

**排序逻辑：**
1. 按 `deadline` 升序（最紧急的在前）
2. 次要按 `case_time` 降序

---

### 矛盾纠纷闭环管理

**默认筛选：**
- 处置进度：`status IN ('未调解', '待盯办')`
- 可通过参数覆盖

**颜色规则应用：**
- `risk_level = '高'` → 红色（#f5222d）
- `risk_level = '中'` → 黄色（#faad14）
- `risk_level = '低'` → 绿色（#52c41a）

**排序逻辑：**
1. 按风险等级优先（高 > 中 > 低）
2. 次要按 `event_time` 降序

---

## 技术实现细节

### ORM 模型定义

使用 SQLAlchemy 定义模型：
```python
from sqlalchemy import Column, Integer, String, DateTime, Text
from app.core.database import Base

class RiskSupervision(Base):
    __tablename__ = "t_risk_supervision"

    id = Column(Integer, primary_key=True, autoincrement=True)
    case_number = Column(String(18), unique=True, nullable=False, index=True)
    # ... 其他字段
```

### JSON 字段处理

**存储：**
```python
risk_issues = json.dumps(["问题1", "问题2"], ensure_ascii=False)
```

**读取：**
```python
risk_issues = json.loads(item.risk_issues)
```

### Excel 导入处理

使用 pandas 读取 Excel：
```python
df = pd.read_excel(file.file, engine='openpyxl')

for _, row in df.iterrows():
    # 解析日期
    case_time = pd.to_datetime(row['案发时间'])

    # 解析数组
    risk_issues = row['风险问题'].split(',')

    # 创建记录
    item = RiskSupervision(...)
    db.add(item)
```

---

## 数据流程图

### 数据查询流程
```
前端请求
  ↓
API 路由 (/api/v1/data/*)
  ↓
服务层 (services/)
  ↓
数据库查询 (models/)
  ↓
应用显示规则 (display_rule service)
  ↓
返回带样式的数据
```

### Excel 导入流程
```
上传 Excel
  ↓
解析 Excel (pandas)
  ↓
数据验证
  ↓
清空现有数据
  ↓
批量插入新数据
  ↓
返回导入结果
```

---

## 总结

### 已实现功能 ✅
1. **执法问题风险盯办表** - 完整的 CRUD 和 Excel 导入
2. **矛盾纠纷闭环管理表** - 完整的 CRUD 和 Excel 导入
3. **显示规则配置表** - 动态配置颜色规则
4. **管理后台 API** - Excel 模板下载、数据导入、规则管理
5. **数据查询 API** - 分页、筛选、排序、样式应用

### 待实现功能 ⏳
1. **警情记录表** - 用于警情态势监控追踪页面
2. **地理编码服务** - 地址转经纬度
3. **统计聚合 API** - 多维度数据统计
4. **地图数据 API** - 警情地理分布

---

## 相关文件

- 模型定义：`backend/app/models/`
- API 路由：`backend/app/api/`
- 服务层：`backend/app/services/`
- 数据库初始化：`backend/app/core/init_db.py`
