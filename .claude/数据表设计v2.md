# 警情态势演示系统 - 数据表设计 v2.0

> **设计理念**：统一警情表 + 配置驱动可视化
> **更新时间**：2026-01-23
> **核心改进**：从多sheet表设计改为单一警情表，通过配置实现灵活的数据分类和可视化

---

## 设计原则

1. **单一数据源**：所有警情数据存储在统一的警情表中
2. **配置驱动**：通过配置表定义数据分类、统计维度、可视化规则
3. **灵活扩展**：新增警情类型或统计维度只需修改配置，无需改表结构
4. **自动聚合**：后端根据配置自动进行数据聚合和统计
5. **地理编码**：支持地址自动转换为经纬度

---

## 核心数据模型

### 1. 警情主表（t_police_alert）

存储所有警情数据的核心表。

| 字段名 | 类型 | 说明 | 必填 | 索引 |
|--------|------|------|------|------|
| id | BIGINT | 主键ID，自增 | ✓ | PRIMARY |
| alert_number | VARCHAR(50) | 警情编号（唯一） | ✓ | UNIQUE |
| alert_type | VARCHAR(50) | 警情类型（见类型枚举） | ✓ | INDEX |
| alert_subtype | VARCHAR(50) | 警情子类型 | - | INDEX |
| alert_name | VARCHAR(200) | 警情名称/标题 | ✓ | - |
| alert_content | TEXT | 警情内容描述 | - | - |
| alert_time | DATETIME | 警情发生时间 | ✓ | INDEX |
| report_time | DATETIME | 报警时间 | - | INDEX |
| location_address | VARCHAR(500) | 地点地址 | - | INDEX |
| location_community | VARCHAR(100) | 所属社区 | - | INDEX |
| location_longitude | DECIMAL(10,7) | 经度 | - | INDEX |
| location_latitude | DECIMAL(10,7) | 纬度 | - | INDEX |
| reporter_name | VARCHAR(100) | 报警人姓名 | - | INDEX |
| reporter_phone | VARCHAR(20) | 报警人电话 | - | - |
| reporter_id_card | VARCHAR(20) | 报警人身份证 | - | - |
| officer_name | VARCHAR(100) | 责任民警 | - | INDEX |
| officer_id | VARCHAR(50) | 责任民警ID | - | INDEX |
| status | VARCHAR(50) | 处理状态（见状态枚举） | ✓ | INDEX |
| risk_level | VARCHAR(20) | 风险等级（高/中/低） | - | INDEX |
| deadline | DATETIME | 处理期限 | - | INDEX |
| closed_time | DATETIME | 结案时间 | - | INDEX |
| is_overdue | TINYINT | 是否超期（0否/1是） | - | INDEX |
| tags | JSON | 标签数组（如：["超期", "重点"]） | - | - |
| extra_data | JSON | 扩展数据（灵活字段） | - | - |
| created_at | DATETIME | 创建时间 | ✓ | INDEX |
| updated_at | DATETIME | 更新时间 | ✓ | INDEX |

#### 警情类型枚举（alert_type）

```python
ALERT_TYPES = {
    "theft": "偷盗/传统盗财",
    "fraud": "通讯网络诈骗/新型盗财",
    "yellow": "涉黄",
    "gamble": "涉赌",
    "dispute": "纠纷",
    "assault": "人身伤害",
    "fight": "打架斗殴",
    "other": "其他有效警情"
}
```

#### 处理状态枚举（status）

```python
STATUS_TYPES = {
    # 案件状态
    "pending": "待处理",
    "investigating": "调查中",
    "closed": "已结案",
    "archived": "已归档",

    # 纠纷状态
    "unmediated": "未调解",
    "supervising": "待盯办",
    "mediating": "调解中",
    "mediated": "已调解",

    # 风险状态
    "risk_pending": "风险待整改",
    "risk_processing": "风险整改中",
    "risk_resolved": "风险已解决"
}
```

---

### 2. 可视化配置表（t_visualization_config）

定义如何对警情数据进行分类、统计和可视化展示。

| 字段名 | 类型 | 说明 | 必填 | 索引 |
|--------|------|------|------|------|
| id | BIGINT | 主键ID，自增 | ✓ | PRIMARY |
| config_code | VARCHAR(50) | 配置编码（唯一） | ✓ | UNIQUE |
| config_name | VARCHAR(100) | 配置名称 | ✓ | - |
| page_code | VARCHAR(50) | 关联页面编码 | ✓ | INDEX |
| chart_type | VARCHAR(50) | 图表类型（见图表类型） | ✓ | - |
| data_source | VARCHAR(50) | 数据源（alert/custom） | ✓ | - |
| filter_rules | JSON | 数据筛选规则 | - | - |
| group_by_field | VARCHAR(50) | 分组字段 | - | - |
| aggregate_function | VARCHAR(50) | 聚合函数（count/sum/avg） | - | - |
| time_dimension | VARCHAR(20) | 时间维度（day/week/month/year） | - | - |
| sort_rules | JSON | 排序规则 | - | - |
| display_rules | JSON | 显示规则（颜色、格式等） | - | - |
| map_config | JSON | 地图配置（如需要） | - | - |
| is_enabled | TINYINT | 是否启用（0否/1是） | ✓ | INDEX |
| display_order | INT | 显示顺序 | - | INDEX |
| created_at | DATETIME | 创建时间 | ✓ | INDEX |
| updated_at | DATETIME | 更新时间 | ✓ | INDEX |

#### 图表类型枚举（chart_type）

```python
CHART_TYPES = {
    "table": "表格",
    "bar": "柱状图",
    "line": "折线图",
    "pie": "饼图",
    "map": "地图",
    "heatmap": "热力图",
    "list": "列表",
    "card": "卡片"
}
```

#### 配置示例

**示例1：警情类型统计（同环比分析）**

```json
{
  "config_code": "alert_type_statistics",
  "config_name": "警情类型统计",
  "page_code": "situation_monitor",
  "chart_type": "table",
  "data_source": "alert",
  "filter_rules": {
    "status": {"$ne": "archived"}
  },
  "group_by_field": "alert_type",
  "aggregate_function": "count",
  "time_dimension": "month",
  "sort_rules": {
    "field": "count",
    "order": "desc"
  },
  "display_rules": {
    "show_comparison": true,
    "comparison_periods": ["week", "month", "year"]
  }
}
```

**示例2：偷盗案件地点分布**

```json
{
  "config_code": "theft_location_distribution",
  "config_name": "偷盗/传统盗财地点分布",
  "page_code": "situation_monitor",
  "chart_type": "map",
  "data_source": "alert",
  "filter_rules": {
    "alert_type": "theft"
  },
  "group_by_field": "location_community",
  "aggregate_function": "count",
  "time_dimension": "month",
  "map_config": {
    "center_field": ["location_longitude", "location_latitude"],
    "marker_type": "cluster",
    "heatmap_enabled": true
  }
}
```

**示例3：超期案件列表**

```json
{
  "config_code": "overdue_cases",
  "config_name": "超期案件列表",
  "page_code": "risk_supervision",
  "chart_type": "table",
  "data_source": "alert",
  "filter_rules": {
    "is_overdue": 1,
    "status": {"$in": ["pending", "investigating"]}
  },
  "sort_rules": {
    "field": "deadline",
    "order": "asc"
  },
  "display_rules": {
    "color_rules": [
      {
        "condition": "days_remaining <= 3",
        "color": "#f5222d",
        "label": "红色"
      },
      {
        "condition": "days_remaining <= 7",
        "color": "#faad14",
        "label": "黄色"
      }
    ]
  }
}
```

**示例4：重复报警人统计**

```json
{
  "config_code": "repeat_reporters",
  "config_name": "重复报警人统计",
  "page_code": "situation_monitor",
  "chart_type": "table",
  "data_source": "alert",
  "group_by_field": "reporter_name",
  "aggregate_function": "count",
  "filter_rules": {
    "reporter_name": {"$ne": null}
  },
  "sort_rules": {
    "field": "count",
    "order": "desc"
  },
  "display_rules": {
    "min_count": 2,
    "show_last_alert_time": true
  }
}
```

---

### 3. 系统配置表（t_system_config）

存储系统级别的配置信息。

| 字段名 | 类型 | 说明 | 必填 | 索引 |
|--------|------|------|------|------|
| id | BIGINT | 主键ID，自增 | ✓ | PRIMARY |
| config_key | VARCHAR(100) | 配置键（唯一） | ✓ | UNIQUE |
| config_value | TEXT | 配置值 | ✓ | - |
| config_type | VARCHAR(20) | 配置类型（string/number/json/color） | ✓ | INDEX |
| description | VARCHAR(200) | 配置说明 | - | - |
| created_at | DATETIME | 创建时间 | ✓ | INDEX |
| updated_at | DATETIME | 更新时间 | ✓ | INDEX |

#### 预设配置项

| config_key | config_value | config_type | description |
|-----------|--------------|-------------|-------------|
| system_title | 沈西所警情态势演示系统 | string | 系统主标题 |
| primary_color | #1890ff | color | 主背景色 |
| tianditu_api_key | - | string | 天地图API Key |
| amap_api_key | - | string | 高德地图API Key |
| default_center_lng | 122.30 | number | 默认地图中心经度 |
| default_center_lat | 29.95 | number | 默认地图中心纬度 |
| auto_geocoding | true | string | 是否自动地理编码 |

---

### 4. 页面配置表（t_page_config）

存储各个页面的配置信息。

| 字段名 | 类型 | 说明 | 必填 | 索引 |
|--------|------|------|------|------|
| id | BIGINT | 主键ID，自增 | ✓ | PRIMARY |
| page_code | VARCHAR(50) | 页面编码（唯一） | ✓ | UNIQUE |
| page_name | VARCHAR(100) | 页面名称 | ✓ | - |
| page_title | VARCHAR(100) | 页面标题 | - | - |
| background_image | VARCHAR(300) | 背景图路径 | - | - |
| nav_button_title | VARCHAR(50) | 导航按钮标题 | - | - |
| nav_button_order | INT | 导航按钮排序 | - | INDEX |
| is_enabled | TINYINT | 是否启用（0否/1是） | ✓ | INDEX |
| created_at | DATETIME | 创建时间 | ✓ | INDEX |
| updated_at | DATETIME | 更新时间 | ✓ | INDEX |

#### 预设页面配置

| page_code | page_name | nav_button_title | nav_button_order |
|-----------|-----------|------------------|------------------|
| officer_location | 警员定位 | 警员定位 | 1 |
| situation_monitor | 警情态势监控追踪 | 警情态势 | 2 |
| risk_supervision | 执法问题风险盯办 | 未办结案件 | 3 |
| dispute_management | 未矛盾纠纷闭环管理 | 未调解纠纷 | 4 |

---

### 5. 地理编码缓存表（t_geocoding_cache）

缓存地址到经纬度的转换结果，避免重复调用API。

| 字段名 | 类型 | 说明 | 必填 | 索引 |
|--------|------|------|------|------|
| id | BIGINT | 主键ID，自增 | ✓ | PRIMARY |
| address | VARCHAR(500) | 地址（唯一） | ✓ | UNIQUE |
| longitude | DECIMAL(10,7) | 经度 | ✓ | - |
| latitude | DECIMAL(10,7) | 纬度 | ✓ | - |
| geocoding_source | VARCHAR(50) | 地理编码来源（tianditu/amap） | - | - |
| confidence | DECIMAL(3,2) | 置信度（0-1） | - | - |
| created_at | DATETIME | 创建时间 | ✓ | INDEX |

---

## 数据流程

### 1. Excel上传流程

```
上传Excel → 解析Excel → 数据验证 → 插入警情表 → 需要地理编码?
                                                    ↓
                                                   是
                                                    ↓
                                        调用地理编码API → 更新经纬度 → 完成
```

### 2. 数据查询流程

```
前端请求 → 读取可视化配置 → 解析筛选规则 → 构建SQL查询 → 执行聚合查询 → 应用显示规则 → 返回结果
```

### 3. 地图展示流程

```
请求地图数据 → 查询警情表 → 有经纬度?
                              ↓
                             否
                              ↓
                    查询地理编码缓存 → 缓存命中?
                                        ↓
                                       否
                                        ↓
                                   调用API → 保存缓存 → 使用缓存 → 返回数据
```

---

## API接口设计

### 1. 警情数据接口

#### POST /api/v1/alerts/upload
上传Excel文件并导入警情数据

**请求：**
- Content-Type: multipart/form-data
- file: Excel文件
- auto_geocoding: 是否自动地理编码（可选，默认true）

**响应：**
```json
{
  "code": 200,
  "message": "导入成功",
  "data": {
    "total_rows": 100,
    "success_count": 98,
    "failed_count": 2,
    "geocoded_count": 95,
    "errors": [
      {"row": 5, "error": "警情编号重复"},
      {"row": 12, "error": "日期格式错误"}
    ]
  }
}
```

#### GET /api/v1/alerts
查询警情数据（支持复杂筛选）

**查询参数：**
- alert_type: 警情类型
- status: 处理状态
- start_time: 开始时间
- end_time: 结束时间
- community: 社区
- officer_name: 责任民警
- is_overdue: 是否超期
- page: 页码
- page_size: 每页数量

**响应：**
```json
{
  "code": 200,
  "data": {
    "total": 150,
    "page": 1,
    "page_size": 20,
    "items": [
      {
        "id": 1,
        "alert_number": "202401150001",
        "alert_type": "theft",
        "alert_name": "电动车被盗",
        "alert_time": "2024-01-15 10:30:00",
        "location_address": "东港街道XX小区",
        "location_community": "东港社区",
        "officer_name": "张三",
        "status": "investigating",
        "is_overdue": 0
      }
    ]
  }
}
```

#### GET /api/v1/alerts/{id}
获取单个警情详情

#### PUT /api/v1/alerts/{id}
更新警情信息

#### DELETE /api/v1/alerts/{id}
删除警情（软删除）

---

### 2. 可视化数据接口

#### GET /api/v1/visualization/data/{config_code}
根据配置获取可视化数据

**查询参数：**
- time_range: 时间范围（week/month/year）
- start_date: 开始日期（可选）
- end_date: 结束日期（可选）

**响应：**
```json
{
  "code": 200,
  "data": {
    "config": {
      "config_code": "alert_type_statistics",
      "config_name": "警情类型统计",
      "chart_type": "table"
    },
    "data": [
      {
        "name": "偷盗/传统盗财",
        "count": 45,
        "week_comparison": "+5.2%",
        "month_comparison": "-2.1%"
      },
      {
        "name": "通讯网络诈骗/新型盗财",
        "count": 38,
        "week_comparison": "+12.5%",
        "month_comparison": "+8.3%"
      }
    ],
    "metadata": {
      "total_count": 150,
      "time_range": "month",
      "generated_at": "2024-01-23 10:00:00"
    }
  }
}
```

#### GET /api/v1/visualization/configs
获取所有可视化配置

#### POST /api/v1/visualization/configs
创建新的可视化配置

#### PUT /api/v1/visualization/configs/{id}
更新可视化配置

---

### 3. 地理编码接口

#### POST /api/v1/geocoding/batch
批量地理编码

**请求：**
```json
{
  "addresses": ["东港街道XX小区", "沈家门街道YY路"]
}
```

**响应：**
```json
{
  "code": 200,
  "data": [
    {
      "address": "东港街道XX小区",
      "longitude": 122.30,
      "latitude": 29.95,
      "source": "cache"
    },
    {
      "address": "沈家门街道YY路",
      "longitude": 122.32,
      "latitude": 29.97,
      "source": "tianditu"
    }
  ]
}
```

---

## Excel导入模板

### 标准警情数据模板

| 列名 | 说明 | 必填 | 示例 |
|------|------|------|------|
| 警情编号 | 唯一编号 | ✓ | 202401150001 |
| 警情类型 | 类型名称 | ✓ | 偷盗/传统盗财 |
| 警情名称 | 简短描述 | ✓ | 电动车被盗 |
| 警情内容 | 详细描述 | - | 报警人称其电动车在小区内被盗 |
| 警情时间 | 发生时间 | ✓ | 2024-01-15 10:30:00 |
| 报警时间 | 报警时间 | - | 2024-01-15 11:00:00 |
| 地点地址 | 详细地址 | - | 东港街道XX小区3号楼 |
| 所属社区 | 社区名称 | - | 东港社区 |
| 报警人姓名 | 姓名 | - | 张三 |
| 报警人电话 | 电话 | - | 13800138000 |
| 责任民警 | 民警姓名 | - | 李四 |
| 处理状态 | 状态 | ✓ | 调查中 |
| 风险等级 | 高/中/低 | - | 中 |
| 处理期限 | 期限时间 | - | 2024-02-15 23:59:59 |

---

## 优势对比

### 原设计（多sheet表）

❌ 每个统计维度需要单独的表
❌ 新增统计需求要改表结构
❌ 数据冗余，维护困难
❌ 前端需要对接多个API
❌ 扩展性差

### 新设计（统一警情表 + 配置驱动）

✅ 单一数据源，数据一致性好
✅ 配置驱动，灵活扩展
✅ 自动聚合，减少冗余
✅ 统一API，前端简单
✅ 支持复杂查询和多维分析
✅ 地理编码缓存，性能优化

---

## 实施步骤

1. **数据库初始化**
   - 创建5张核心表
   - 插入预设配置数据
   - 创建必要的索引

2. **Excel解析服务**
   - 实现标准模板解析
   - 数据验证和清洗
   - 自动地理编码

3. **可视化配置服务**
   - 配置CRUD接口
   - 动态SQL构建
   - 数据聚合引擎

4. **前端适配**
   - 统一数据接口调用
   - 配置驱动的组件渲染
   - 地图组件集成

---

## 扩展性示例

### 新增统计维度

只需添加一条可视化配置，无需改表结构：

```json
{
  "config_code": "officer_workload",
  "config_name": "民警工作量统计",
  "page_code": "situation_monitor",
  "chart_type": "bar",
  "data_source": "alert",
  "group_by_field": "officer_name",
  "aggregate_function": "count",
  "time_dimension": "month"
}
```

### 新增警情类型

只需在警情表中使用新的alert_type值，配置会自动识别：

```sql
INSERT INTO t_police_alert (alert_type, ...)
VALUES ('traffic_accident', ...);
```

---

## 总结

新设计通过**统一警情表 + 配置驱动可视化**的方式，实现了：

1. **数据集中管理**：所有警情数据统一存储
2. **灵活配置**：通过配置表定义各种统计和可视化
3. **自动聚合**：后端根据配置自动进行数据聚合
4. **易于扩展**：新增需求只需修改配置，无需改表
5. **性能优化**：地理编码缓存、合理索引

这种设计更符合实际业务需求，也更易于维护和扩展。
